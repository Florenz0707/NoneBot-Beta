from nonebot.plugin import PluginMetadata
from nonebot.adapters.onebot.v11 import Bot, PrivateMessageEvent, Message, GroupMessageEvent
from nonebot import on_command, get_bot, get_driver, logger
from nonebot.permission import SUPERUSER
from nonebot.params import CommandArg
import time
import asyncio

__plugin_meta__ = PluginMetadata(
    name='send',
    description='é€šçŸ¥å’Œåé¦ˆåŸºæœ¬åŠŸèƒ½',
    usage='',
)

all_menu = on_command('help', aliases={'menu', 'h'}, priority=5)


@all_menu.handle()
async def _():
    message = """========R-I-F-T========
1> æ’ä»¶åˆ—è¡¨:
| Leetcode2: .lc
| ä»Šæ—¥äººå“2: .jrrp
| ZXPIX: .zxpix
| å‘ç—…è¯­å½•: .suki
| STEAMæ’­æŠ¥: .steam
| EMOJIåˆå¹¶: ğŸ˜‡+ğŸ¥°
| å‘é€åé¦ˆ: .send
| è®¾ç½®é—¹é’Ÿ: .clock
| åŒ–èº«æŠ½è±¡: .ab
2> ç”¨æ³•å¸®åŠ©:
| .jrrp | .weekjrrp | .monthjrrp | .alljrrp
 => è·å–ä»Šæ—¥|æœ¬å‘¨|æœ¬æœˆ|å…¨éƒ¨çš„äººå“å€¼
| .suki [text | @ta]
 => å¯¹ç€æŸäº‹æˆ–æŸäººå‘ç”µ
| EMOJIåˆå¹¶: ç›´æ¥å¦‚ä¸Šæ–‡ä½¿ç”¨ï¼Œä»…é™emoji
| .send [text]
 => åé¦ˆçš„ä¿¡æ¯ä¼šç›´æ¥é€šè¿‡æœºå™¨äººç§èŠåˆ°ç®¡ç†å‘˜
| .ab [text]
 => å°†æ–‡æœ¬æŠ½è±¡åŒ–ï¼ˆä½¿ç”¨emojiä»£æ›¿ï¼‰
| å…¶ä½™æ’ä»¶å¯ä½¿ç”¨ æ’ä»¶.help è·å–å¸®åŠ©
 ä¾‹å¦‚: .lc.help | .lc.menu
    """
    await all_menu.finish(message)


inform = on_command('inform', priority=10, block=True, permission=SUPERUSER)


@inform.handle()
async def notice_receive(bot: Bot, event: PrivateMessageEvent):
    message = event.raw_message.replace('.inform', '', 1).strip().strip('\n')
    group_list = await bot.call_api('get_group_list')
    await inform.send(f'æ­£åœ¨ä¼ è¾¾æ¶ˆæ¯......')
    for item in group_list:
        await bot.call_api('send_group_msg', **{
            'message': message,
            'group_id': item['group_id'],
        })
        await asyncio.sleep(5)
    await inform.finish(f'æ¶ˆæ¯å·²ç»ä¼ è¾¾å®Œæ¯•äº†å“¦ï¼')


async def sendtosuperuser(message):
    superusers = get_driver().config.superusers
    bot = get_bot()
    for superuser in superusers:
        await bot.call_api('send_msg', **{
            'message': message,
            'user_id': superuser,
        })
        await asyncio.sleep(3)


send = on_command('send', priority=5, block=True)


@send.handle()
async def send_receive(bot: Bot, event: GroupMessageEvent, args: Message = CommandArg()):
    message = event.raw_message.replace('.send', '', 1).strip().strip('\n')
    name = event.sender.nickname
    group = await bot.call_api('get_group_info', **{
        'group_id': event.group_id,
    })
    group_name = group['group_name']
    timenow = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime())
    sendmsg = f"æ—¶é—´ï¼š{timenow}\næ¥è‡ªç¾¤èŠï¼š{group_name}\nå‘é€è€…ï¼š{name}\nå†…å®¹ï¼š{message}"
    logger.warning(f"SendMSG: {sendmsg}")
    await sendtosuperuser(sendmsg)
    await send.finish(f'å·²ç»æŠŠæ„è§ä¼ è¾¾ç»™Masteräº†~ï¼')
