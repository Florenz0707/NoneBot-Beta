from nonebot.plugin import PluginMetadata
from nonebot.adapters.onebot.v11 import Bot, PrivateMessageEvent
from nonebot import on_command
from nonebot.permission import SUPERUSER
from nonebot.adapters.onebot.v11 import Bot, Message, GroupMessageEvent
from nonebot.params import CommandArg
from nonebot import get_bot, get_driver
from nonebot import logger
import time
import asyncio

__plugin_meta__ = PluginMetadata(
    name='send',
    description='通知和反馈基本功能',
    usage='',
)

inform = on_command('inform', priority=10, permission=SUPERUSER)


@inform.handle()
async def notice_receive(bot: Bot, event: PrivateMessageEvent):
    message = event.raw_message.replace('.inform', '', 1).strip().strip('\n')
    grouplist = await bot.call_api('get_group_list')
    await inform.send(f'通知正在传达喵！')
    for i in range(len(grouplist)):
        await bot.call_api('send_group_msg', **{
            'message': message,
            'group_id': grouplist[i]['group_id'],
        })
        await asyncio.sleep(5)
    await inform.finish(f'通知已经传达完毕了喵！')


async def sendtosuperuser(message):
    superusers = get_driver().config.superusers
    bot = get_bot()
    cnt = 0
    for superuser in superusers:
        cnt += 1
        await bot.call_api('send_msg', **{
            'message': message,
            'user_id': superuser,
        })
        await asyncio.sleep(3)
    logger.warning(f"cnt:{cnt}")


send = on_command('send', priority=5)


@send.handle()
async def send_receive(bot: Bot, event: GroupMessageEvent, args: Message = CommandArg()):
    message = event.raw_message.replace('.send', '', 1).strip().strip('\n')
    name = event.sender.nickname
    group = await bot.call_api('get_group_info', **{
        'group_id': event.group_id,
    })
    group_name = group['group_name']
    timenow = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime())
    sendmsg = timenow + '\n来自群聊：' + group_name + '\n发送者：' + name + '\n' + message
    logger.warning(f"SendMSG: {sendmsg}")
    await sendtosuperuser(sendmsg)
    await send.finish(f'已经把意见传达给Master了喵！')
